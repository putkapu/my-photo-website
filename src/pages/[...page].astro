---
import type { GetStaticPaths } from 'astro'
import BaseLayout from '../layouts/BaseLayout.astro'
import { getCollection } from 'astro:content'

export const getStaticPaths = (() => {
  return [{ params: { page: undefined } }]
}) satisfies GetStaticPaths

const allPosts = await getCollection('posts')
const sortedPosts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
const tagOrder = ['technology', 'consciousness', 'notes']
const uniqueTags = tagOrder.filter(tag => allPosts.some(post => post.data.tag === tag))

const allPostsData = sortedPosts.map(post => ({
  title: post.data.title,
  slug: post.slug,
  tag: post.data.tag,
  date: post.data.date.toISOString(),
  excerpt: post.body?.replace(/^---[\s\S]*?---\s*/, '').replace(/\n/g, ' ').trim().slice(0, 140) || ''
}))
---

<BaseLayout title="Ruan Putka">
  <h1>Posts</h1>
  
  <div class="tag-filter no-transition" id="tagFilter" role="group" aria-label="Filter posts by tag">
    <button class="tag-btn" data-tag="all">All</button>
    {uniqueTags.map(tag => (
      <button class="tag-btn" data-tag={tag}>{tag}</button>
    ))}
  </div>
  
  <ul class="post-list" id="postList"></ul>
  
  <p id="noResults" class="no-results" style="display: none;">No posts found with this tag.</p>
  
  <nav class="pagination" id="pagination" aria-label="Pagination" style="display: none;">
    <button class="pagination-link prev" id="prevBtn" type="button">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      Prev
    </button>
    
    <span class="pagination-info" id="paginationInfo">1 / 1</span>
    
    <button class="pagination-link next" id="nextBtn" type="button">
      Next
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </nav>
  
  <script type="application/json" id="allPostsData" set:html={JSON.stringify(allPostsData)} />
</BaseLayout>

<style>
  .tag-filter {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .tag-btn {
    background: transparent;
    border: 1px solid var(--border-color);
    padding: 0.3rem 0.65rem;
    border-radius: 4px;
    font-family: inherit;
    font-size: 0.8rem;
    color: var(--secondary-text);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .no-transition .tag-btn {
    transition: none;
  }

  .tag-btn:hover {
    border-color: var(--primary-text);
    color: var(--primary-text);
  }

  .tag-btn.active {
    background: var(--primary-text);
    border-color: var(--primary-text);
    color: var(--background);
  }

  .no-results {
    color: var(--secondary-text);
    font-style: italic;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1.5rem;
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
  }

  .pagination-link {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.9rem;
    font-family: inherit;
    color: var(--secondary-text);
    text-decoration: none;
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .pagination-link:hover:not(.disabled) {
    color: var(--primary-text);
  }

  .pagination-link.disabled {
    opacity: 0.4;
    cursor: default;
    pointer-events: none;
  }

  .pagination-info {
    font-size: 0.85rem;
    color: var(--secondary-text);
  }

  @media (max-width: 640px) {
    .tag-btn {
      flex-shrink: 0;
      padding: 0.5rem 1rem;
      min-height: 44px;
    }
  }
</style>

<script>
  interface Post {
    title: string
    slug: string
    tag: string
    date: string
    excerpt: string
  }

  const PAGE_SIZE = 6
  let currentPage = 1
  let selectedTag = 'all'
  
  const allPostsData: Post[] = JSON.parse(document.getElementById('allPostsData')?.textContent || '[]')
  const tagFilter = document.getElementById('tagFilter')
  const tagButtons = document.querySelectorAll('.tag-btn')
  const postList = document.getElementById('postList')
  const noResults = document.getElementById('noResults')
  const pagination = document.getElementById('pagination')
  const paginationInfo = document.getElementById('paginationInfo')
  const prevBtn = document.getElementById('prevBtn')
  const nextBtn = document.getElementById('nextBtn')

  function formatDate(dateStr: string): string {
    const date = new Date(dateStr)
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      timeZone: 'UTC'
    })
  }

  function createPostHTML(post: Post): string {
    const formattedDate = formatDate(post.date)
    const excerptWithEllipsis = post.excerpt.length >= 120 ? post.excerpt + '...' : post.excerpt
    
    return `
      <li>
        <article class="post-item">
          <div class="post-title-row">
            <h2 class="post-title">
              <a href="/posts/${post.slug}">${post.title}</a>
            </h2>
            <button class="post-tag" data-filter-tag="${post.tag}">${post.tag}</button>
          </div>
          ${post.excerpt ? `<p class="post-excerpt">${excerptWithEllipsis}</p>` : ''}
          <div class="post-meta">
            <span class="post-date">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <time datetime="${post.date}">${formattedDate}</time>
            </span>
          </div>
        </article>
      </li>
    `
  }

  function getFilteredPosts(): Post[] {
    if (selectedTag === 'all') {
      return allPostsData
    }
    return allPostsData.filter(post => post.tag === selectedTag)
  }

  function render() {
    const filtered = getFilteredPosts()
    const totalPages = Math.ceil(filtered.length / PAGE_SIZE)
    
    if (currentPage > totalPages) {
      currentPage = Math.max(1, totalPages)
    }
    
    const startIndex = (currentPage - 1) * PAGE_SIZE
    const pagePosts = filtered.slice(startIndex, startIndex + PAGE_SIZE)
    
    tagButtons.forEach(b => {
      b.classList.toggle('active', b.getAttribute('data-tag') === selectedTag)
    })
    
    if (postList) {
      postList.setAttribute('data-hide-tags', selectedTag !== 'all' ? 'true' : 'false')
      postList.innerHTML = pagePosts.map(post => createPostHTML(post)).join('')
      
      postList.querySelectorAll('[data-filter-tag]').forEach(btn => {
        btn.addEventListener('click', () => {
          const tag = btn.getAttribute('data-filter-tag')
          if (tag) {
            selectedTag = tag
            currentPage = 1
            localStorage.setItem('selectedTag', tag)
            updateUrlWithTag(tag)
            render()
          }
        })
      })
    }
    
    if (noResults) {
      noResults.style.display = filtered.length === 0 ? '' : 'none'
    }
    
    if (pagination && paginationInfo && prevBtn && nextBtn) {
      if (totalPages > 1) {
        pagination.style.display = ''
        paginationInfo.textContent = `${currentPage} / ${totalPages}`
        
        prevBtn.classList.toggle('disabled', currentPage <= 1)
        nextBtn.classList.toggle('disabled', currentPage >= totalPages)
      } else {
        pagination.style.display = 'none'
      }
    }
  }

  prevBtn?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--
      render()
      window.scrollTo(0, 0)
    }
  })

  nextBtn?.addEventListener('click', () => {
    const filtered = getFilteredPosts()
    const totalPages = Math.ceil(filtered.length / PAGE_SIZE)
    if (currentPage < totalPages) {
      currentPage++
      render()
      window.scrollTo(0, 0)
    }
  })

  function updateUrlWithTag(tag: string) {
    const url = new URL(window.location.href)
    if (tag === 'all') {
      url.searchParams.delete('tag')
    } else {
      url.searchParams.set('tag', tag)
    }
    history.replaceState({}, '', url)
  }

  tagButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const tag = btn.getAttribute('data-tag')
      if (tag) {
        selectedTag = tag
        currentPage = 1
        localStorage.setItem('selectedTag', tag)
        updateUrlWithTag(tag)
        render()
      }
    })
  })

  const urlParams = new URLSearchParams(window.location.search)
  const urlTag = urlParams.get('tag')
  const validTags = Array.from(tagButtons).map(btn => btn.getAttribute('data-tag')).filter(Boolean)
  
  if (urlTag && validTags.includes(urlTag)) {
    selectedTag = urlTag
    localStorage.setItem('selectedTag', urlTag)
  } else {
    selectedTag = 'all'
    localStorage.removeItem('selectedTag')
  }
  
  render()
  
  requestAnimationFrame(() => {
    tagFilter?.classList.remove('no-transition')
  })
</script>
