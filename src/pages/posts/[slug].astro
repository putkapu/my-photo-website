---
import BaseLayout from '../../layouts/BaseLayout.astro'
import { getCollection, render } from 'astro:content'

export async function getStaticPaths() {
  const posts = await getCollection('posts')
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }))
}

const { post } = Astro.props
const { Content } = await render(post)

const formattedDate = post.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  timeZone: 'UTC'
})
---

<BaseLayout title={`${post.data.title} - Ruan Putka`}>
  <article>
    <header class="post-header">
      <h1>{post.data.title}</h1>
      <div class="post-meta">
        <time datetime={post.data.date.toISOString()}>{formattedDate}</time>
        <a href={`/?tag=${post.data.tag}`} class="post-tag">{post.data.tag}</a>
      </div>
    </header>
    <div class="post-content">
      <Content />
    </div>
  </article>
  <a href="/" class="back-link" id="backLink">&larr; Back to posts</a>
</BaseLayout>

<style>
  .back-link {
    display: inline-block;
    margin-top: 3rem;
    color: var(--secondary-text);
    font-size: 0.9rem;
  }

  .back-link:hover {
    color: var(--accent-color);
  }
</style>

<script>
  const backLink = document.getElementById('backLink') as HTMLAnchorElement | null
  
  if (backLink) {
    try {
      const stateJson = sessionStorage.getItem('postsListState')
      if (stateJson) {
        const state = JSON.parse(stateJson)
        const stateAge = Date.now() - state.timestamp
        const MAX_AGE = 30 * 60 * 1000
        
        if (stateAge < MAX_AGE && state.url) {
          const stateUrl = new URL(state.url)
          if (stateUrl.pathname === '/' || stateUrl.pathname === '') {
            backLink.href = state.url
            sessionStorage.setItem('postsListScrollRestore', state.scrollY.toString())
          }
        }
      }
    } catch (e) {
      console.log('Failed to restore posts list state:', e)
    }
  }
</script>
