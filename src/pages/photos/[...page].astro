---
import type { GetStaticPaths } from 'astro'
import { Image, getImage } from 'astro:assets'
import BaseLayout from '../../layouts/BaseLayout.astro'

const featuredOrder = [
  1, 6, 39,
  2, 11, 12,
  46, 24, 19,
  10, 30, 31,
  15, 16, 17
]

const allImages = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/photos/*.jpg',
  { eager: true }
)

const getPhotoNumber = (path: string): number => {
  const match = path.match(/\/(\d+)\.jpg$/)
  return match ? parseInt(match[1], 10) : -1
}

const allPhotoNumbers = Object.keys(allImages)
  .map(getPhotoNumber)
  .filter(n => n >= 0)

const remainingPhotos = allPhotoNumbers
  .filter(n => !featuredOrder.includes(n))
  .sort((a, b) => a - b)

const orderedPhotos = [...featuredOrder, ...remainingPhotos]

const photoDataRaw = orderedPhotos
  .map(num => {
    const path = `/src/assets/photos/${num}.jpg`
    const imageModule = allImages[path]
    if (!imageModule) return null
    return {
      num,
      image: imageModule.default,
    }
  })
  .filter(Boolean) as { num: number; image: ImageMetadata }[]

const allPhotoData = await Promise.all(
  photoDataRaw.map(async (photo) => {
    const fullImage = await getImage({ src: photo.image, width: 1600 })
    return {
      ...photo,
      fullSrc: fullImage.src,
    }
  })
)

const PAGE_SIZE = 15

export const getStaticPaths = (async ({ paginate }) => {
  const allImages = import.meta.glob<{ default: ImageMetadata }>(
    '/src/assets/photos/*.jpg',
    { eager: true }
  )
  
  const featuredOrder = [
    1, 6, 39,
    2, 11, 12,
    46, 24, 19,
    10, 30, 31,
    15, 16, 17
  ]
  
  const getPhotoNumber = (path: string): number => {
    const match = path.match(/\/(\d+)\.jpg$/)
    return match ? parseInt(match[1], 10) : -1
  }
  
  const allPhotoNumbers = Object.keys(allImages)
    .map(getPhotoNumber)
    .filter(n => n >= 0)
  
  const remainingPhotos = allPhotoNumbers
    .filter(n => !featuredOrder.includes(n))
    .sort((a, b) => a - b)
  
  const orderedPhotos = [...featuredOrder, ...remainingPhotos]
  
  const photoData = orderedPhotos
    .map(num => {
      const path = `/src/assets/photos/${num}.jpg`
      const imageModule = allImages[path]
      if (!imageModule) return null
      return { num, image: imageModule.default }
    })
    .filter(Boolean)
  
  return paginate(photoData, { pageSize: 15 })
}) satisfies GetStaticPaths

const { page } = Astro.props

const pagePhotos = await Promise.all(
  page.data.map(async (photo: { num: number; image: ImageMetadata }) => {
    const fullImage = await getImage({ src: photo.image, width: 1600 })
    return {
      ...photo,
      fullSrc: fullImage.src,
    }
  })
)
---

<BaseLayout title="Photos | Ruan Putka">
  <h1>Photos</h1>
  
  <div class="photo-grid" id="photoGrid">
    {pagePhotos.map((photo, index) => (
      <div 
        class="photo-container"
        data-full-src={photo.fullSrc}
      >
        <Image 
          class="photo" 
          src={photo.image}
          width={300}
          alt=""
          loading={index < 6 ? "eager" : "lazy"}
        />
      </div>
    ))}
  </div>

  {page.lastPage > 1 && (
    <nav class="pagination" aria-label="Pagination">
      {page.url.prev ? (
        <a href={page.url.prev} class="pagination-link prev">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Prev
        </a>
      ) : (
        <span class="pagination-link prev disabled">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Prev
        </span>
      )}
      
      <span class="pagination-info">{page.currentPage} / {page.lastPage}</span>
      
      {page.url.next ? (
        <a href={page.url.next} class="pagination-link next">
          Next
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </a>
      ) : (
        <span class="pagination-link next disabled">
          Next
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </span>
      )}
    </nav>
  )}

  <div id="modal" class="modal" style="display: none;">
    <img id="modalImage" class="modal-image" src="" alt="" />
  </div>
</BaseLayout>

<style>
  h1 {
    margin-bottom: 2rem;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1.5rem;
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
  }

  .pagination-link {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.9rem;
    color: var(--secondary-text);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .pagination-link:hover:not(.disabled) {
    color: var(--primary-text);
  }

  .pagination-link.disabled {
    opacity: 0.4;
    cursor: default;
  }

  .pagination-info {
    font-size: 0.85rem;
    color: var(--secondary-text);
  }
</style>

<script>
  const modal = document.getElementById('modal')
  const modalImage = document.getElementById('modalImage')

  const photoGrid = document.getElementById('photoGrid')
  if (photoGrid) {
    photoGrid.addEventListener('click', (e) => {
      const target = e.target
      const container = target.closest('.photo-container')
      if (container) {
        const fullSrc = container.getAttribute('data-full-src')
        if (fullSrc && modalImage && modal) {
          modalImage.src = fullSrc
          modal.style.display = 'flex'
          document.body.style.overflow = 'hidden'
        }
      }
    })
  }

  if (modal) {
    modal.addEventListener('click', () => {
      modal.style.display = 'none'
      document.body.style.overflow = ''
    })
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
      modal.style.display = 'none'
      document.body.style.overflow = ''
    }
  })
</script>
